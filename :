open Ocaml_twixt_lib
open Ocaml_twixt_exchange

let game_manager =
  Gamemanager.create Serverconfig.cache_ttl Serverconfig.cache_hashtbl_size
;;

let conn_manager = Handlers.ConnManager.create ()

let handle_client client =
  let client_id = Handlers.ConnManager.track conn_manager client in
  let rec loop () =
    match%lwt Dream.receive client with
    | Some message ->
      (match Wsmes.parse message with
       | Some mes ->
         let%lwt () = Handlers.websocket client (client_id, clients) mes in
         loop ()
       | None ->
         let%lwt () = Handlers.wsend_error "invalid json" in
         loop ())
    | None ->
      Handlers.ConnManager.forget conn_manager client_id;
      Dream.close_websocket client
  in
  loop ()
;;

let () =
  Dream.run ~interface:Serverconfig.listen_interface ~port:Serverconfig.listen_port
  @@ Dream.logger
  @@ Dream.router
       [ Dream.post
           "/login"
           (Handlers.json_receiver Types.login_request_doc_of_yojson Handlers.login)
       ; Dream.post
           "/refresh"
           (Handlers.json_receiver Types.refresh_request_doc_of_yojson Handlers.refresh)
       ; Dream.post "/register" Handlers.register
       ; Dream.get "/leaderboard" Handlers.get_leaderboard
       ; Dream.get "/users/:id" Handlers.get_user_by_id
       ; Dream.get "/games" Handlers.get_game_list
       ; Dream.delete "/users" Handlers.delete_self
       ; Dream.get "/websocket" (fun _ -> Dream.websocket handle_client)
       ]
;;
